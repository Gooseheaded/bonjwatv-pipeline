---
date: 2025-09-18
tags: [sessions]
env: both
---

# Session â€” 2025-09-18

## Context
- Feature request: track per-user "watched" videos when a user watches at least 30s on the Watch page, and surface a WATCHED overlay on video cards in list/search views.
- Persistence must be server-side, but we should avoid fetching on every page load; client-side cache is acceptable.

## Changes
- Server (webapp)
  - Added per-user watched persistence under `/app/data/watched` via `IUserWatchStore` (`FileUserWatchStore`).
  - Endpoints:
    - `POST /account/watched/{id}` marks the current video as watched for the user (Discord ID or anon cookie `bwkt.uid`).
    - `GET /account/watched` returns `{ ids: string[] }` for hydration.
  - Anonymous users receive a long-lived HttpOnly cookie `bwkt.uid` (2 years).
- Client
  - `watched.js`: localStorage cache (`bwkt_watched_v1`), hydrate-if-stale (12h), force-refresh method, and card annotation helpers.
  - Force refresh on write: after successfully POSTing a watched mark, the client immediately re-fetches `/account/watched` and updates overlays.
  - Subtitles/player integration: `subtitles.js` exposes a `bwktOnPlayerStateChange` hook; the Watch page starts a 30s timer on PLAYING, cancels on pause/buffer/stop.
  - Index/Search markup: add `video-card` with `data-video-id`, a hidden `WATCHED` badge, and include `watched.js` to hydrate and annotate.
  - CSS: `.video-card.watched` overlay + `.watched-badge` styling. Storage event listener updates overlays across tabs.
  - Analytics: If `GA_MEASUREMENT_ID` is set, loads GA4 via gtag.js in `_Layout`. Watch page sends `video_watched_30s` with `{ video_id, page_path, page_title }` when marking watched.

## Decisions
- Persist on the webapp for now (file-backed store); consider migrating to Catalog API later if centralization is desired.
- Do not fetch watched IDs on every page load; hydrate cache at most every 12 hours and update immediately upon marking (update-on-write).
- Support both authenticated and anonymous users; identity keyed by Discord ID or anon cookie.

## Next Steps
- Optional: user toggle to hide/show watched overlays (persisted in localStorage).
- Consider de-duplication/compaction limits if the watched list grows very large.
- If multiple webapp instances are introduced, ensure a shared volume or move persistence to the API/DB.

## Links
- Server: `webapp/Program.cs`, `webapp/Services/IUserWatchStore.cs`
- Client: `webapp/wwwroot/js/watched.js`, `webapp/wwwroot/js/subtitles.js`
- Pages: `webapp/Pages/Watch.cshtml`, `webapp/Pages/Index.cshtml`, `webapp/Pages/Search.cshtml`
- Styles: `webapp/wwwroot/css/site.css`
