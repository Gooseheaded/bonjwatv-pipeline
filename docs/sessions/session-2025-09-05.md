# BWKT Monorepo ‚Äî Session Summary (2025-09-05)

## Context

- Implement core BWKT features for a stable containerized monorepo (webapp + catalog-api) with session-based docs.
- Address pagination regressions, add OAuth scaffolding, ratings pipeline, admin views, and safe deploys.

## Changes

- Pagination: standardized `pageNum`/`pageSize` on webapp Index/Search; computed `TotalCount/TotalPages`; added Razor pager; added unit + integration tests.
- Compose Watch: configured `develop.watch` for webapp and API; synced `webapp/data` into container for instant `videos.json` reload.
- Navbar/Login: moved Patreon to left nav; added Login button; created `/account/login` skeleton.
- Auth: added Cookie auth; `/account/callback` handles Discord exchange or demo mode; `/account/logout`; only shows Logout when authenticated.
- Ratings: JSON-backed `RatingsRepository` with aggregates + events; webapp proxy endpoints; Watch page loads and submits ratings; server-renders counts to avoid flash.
- Admin: added `/admin/ratings/recent` API and webapp page; gated via `ADMIN_USER_IDS`.
- Deploy safety: production compose with `web-data` and `api-data` volumes; `scripts/package-docker.sh` now bundles a `run.sh` that backs up volumes before update.
- Docs: wrote `DEVELOPING.md` (compose watch), `DEPLOYING.md` (prod flow + backups), and integration plans (below).

## Decisions

- Prefer server-rendered pagination and counts to avoid UI flash.
- Keep API unauthenticated internally; secure admin via webapp proxy and `ADMIN_USER_IDS` until JWT is introduced.
- Persist ratings and events in JSON initially; bound file size; plan smooth DB migration later.
- Use environment-driven URLs: `DATA_CATALOG_URL` for catalog, `CATALOG_API_BASE_URL` optional override.

## Next Steps

- Identity hardening: signed JWT between webapp and API for ratings/submissions.
- Implement Submissions Queue endpoints and admin UI.
- First‚Äëparty subtitles upload/serve endpoints; mirror external URLs on approval.
- Admin UX: link video titles; filters and pagination.
- Optional: migrate JSON stores to SQLite/Postgres without breaking contracts.

## Plans (New)

- Submissions Queue Design: docs/catalog-api/SUBMISSIONS.md
- First‚ÄëParty Subtitles Plan: docs/catalog-api/SUBTITLES.md
- Translator Integration Guide: docs/translator/CATALOG_INTEGRATION.md

## Links

- Related docs: `docs/webapp/PLAN.md` (Pagination), Catalog API surface in `docs/catalog-api/CONTRIBUTIONS.md` (read endpoints and params).
- Submissions Queue: `docs/catalog-api/SUBMISSIONS.md`
- Subtitles Storage: `docs/catalog-api/SUBTITLES.md`
- Translator Integration: `docs/translator/CATALOG_INTEGRATION.md`

## Addendum ‚Äî Release Features

- Submissions & Subtitles
  - Catalog API: Upload SRTs, ingest submissions via token (`API_INGEST_TOKENS`), admin list/detail/approve.
  - Approval flow: Ensures first‚Äëparty subtitles, upserts into `videos.json`.
  - Translator: `submit_to_catalog.py` (auto-stubs SRTs), GUI ‚ÄúSubmit after run‚Äù, `scaffold_test_submission.py` helper.
- Submitter attribution
  - Tokens format: `bonjwatv_token_<USERNAME>_<MD5(USERNAME)>` ‚Üí parsed to `submitter`.
  - Videos store `submitter` and `submissionDate`; Watch page displays them.
- Admin UI (broad/narrow)
  - Admin page: Recent Ratings, Pending Submissions (Open ‚Üí detail) with success banner.
  - Detail page: Approve/Reject; Watch adds admin-only ‚ÄúHide‚Ä¶‚Äù button.
- Hidden videos management
  - Catalog API: hide/show/delete with reason/timestamp; search excludes hidden.
  - Admin page: ‚ÄúHidden Videos‚Äù list (Open ‚Üí detail); detail page has Show/Delete.
- Dev compose
  - Made catalog-api mount to `./webapp/data` writable; approvals and hides update host `videos.json` in dev; webapp reloads automatically.

---

## Production Incident ‚Äî Search Returned No Results (Evening)

### Context
- Prod homepage showed videos, but Search returned no results. Occurred after deploying submissions + subtitles release.

### Root Cause
- In production, `catalog-api` read `Data:JsonPath` from appsettings (defaulting to `../webapp/data/videos.json`), which does not exist in the prod container.
- The API therefore served an empty catalog while the webapp homepage still had its own baked `data/videos.json` ‚Üí Search (API-backed) returned 0 items.

### Fixes Applied
- Seeded API data on server: added `scripts/seed-api-videos.sh` to diagnose and populate `api-data/videos.json` safely.
- Packaging hardening:
  - `scripts/package-docker.sh` now bundles a seed `videos.json` (or warns) and `run.sh` pre-creates volumes and seeds `api-data/videos.json` only if missing.
  - Compose sets both `DATA_JSON_PATH` and `Data__JsonPath` to `/app/data/videos.json` so env var wins in prod.
- Webapp resilience: `VideoService` falls back to local search if API returns 0 items and local data exists (prevents empty first-run UX).

### Deployment/Proxy Changes
- Exposed `catalog-api` on host `5002` in prod compose for reverse proxying.
- Wrote `nginx.txt` with targeted routes:
  - Block `/api/admin/*` (403).
  - Proxy `POST /api/submissions/videos`, `POST /api/uploads/subtitles`, and `GET /api/subtitles/*` to `catalog-api`.
- `scripts/deploy-to-server.sh` now preserves an existing `.env` across bundle updates (copies out and restores).

### Feature: Delete Subtitles on Reject (with safety)
- Implemented: When an admin rejects a submission, delete its stored subtitle file only if it is not referenced by `videos.json`.
- Helpers handle both `v1` and `v1.srt` storage-key formats; sanitize IDs.

### Tests
- Added integration tests:
  - `Reject_Deletes_Unreferenced_Subtitle` ‚Äî file removed after reject when not referenced.
  - `Reject_DoesNot_Delete_When_Referenced_In_Videos` ‚Äî file retained when `videos.json` references it.
- All tests pass.

### Ratings UX Improvements
- Watch page:
  - Highlights the current user‚Äôs rating; clicking the selected rating removes it (new DELETE endpoint).
  - Webapp forwards identity headers on GET/POST/DELETE so the API can return `UserRating`.
- Search page: shows a compact ratings summary (üî¥ üü° üü¢) on each card.
- API: `GET /api/videos/{id}/ratings` now surfaces `UserRating` as a string and prefers forwarded identity headers, enabling highlighting.
- API: `DELETE /api/videos/{id}/ratings` removes the current user‚Äôs rating and decrements aggregates.
- Tests: added `Ratings_Remove_Clears_User_And_Counts` to verify POST‚ÜíGET (with user)‚ÜíDELETE‚ÜíGET flow.

### Translator GUI Updates
- Renamed section to ‚Äúbonjwa.tv integration‚Äù, moved it below Pipeline steps.
- Renamed label to ‚Äúbonjwa.tv URL‚Äù with default `https://bonjwa.tv`.
- Disabled URL/token inputs until ‚ÄúSubmit results to bonjwa.tv‚Äù is checked.
- Version label bumped to v250905.
- Translator submission script now logs a friendly message on 403 (invalid ingest token).

### Verification
- Seeded and restarted API; Search works for `all` and `race=z`.
- Reverse proxy routing validated for submissions and subtitles; admin remains blocked externally.

### Next Steps (Follow-ups)
- Optional: add audit log entries for delete-on-reject actions.
- Optional: periodic GC task to prune orphaned subtitles not referenced by `videos.json` and not in pending submissions.
- Consider binding API to loopback on the LXC and proxy via Nginx only (firewall tighten), if not already enforced.

### Links
- Compose change: `docker-compose.prod.yml` (catalog-api port 5002; Data__JsonPath)
- Seed/diagnostics: `scripts/seed-api-videos.sh`
- Packaging updates: `scripts/package-docker.sh` (seeding & run.sh), `scripts/deploy-to-server.sh` (.env preservation)
- Reverse proxy sample: `nginx.txt`
