# BWKT Monorepo — Session Summary (2025-09-03)

## Highlights

- Webapp and Catalog API both containerized and running via Docker Compose.
- Clean dev/prod setup with overrides, restart policies, and persistent data volume.
- Monorepo tooling added to import sibling repos with history and keep a unified solution.

## Fixes and Changes

- Catalog API
  - Resolved CS8803 by moving `VideoDto` record below top-level statements in `catalog-api/Program.cs`.
  - Added Swagger support by referencing `Swashbuckle.AspNetCore`.
  - Dockerfile switched to `dotnet publish` output; supports `BUILD_CONFIGURATION` arg.
  - Enabled Swagger in dev only by setting `ASPNETCORE_ENVIRONMENT=Development` in compose.

- Webapp
  - Fixed static web assets issue in container by publishing to `/app/publish` and copying publish output.
  - Dockerfile switched to `dotnet publish` output; supports `BUILD_CONFIGURATION` arg.

- Compose and Deployment
  - Removed obsolete `version:` key from `docker-compose.yml` and added `restart: unless-stopped`.
  - Added production overrides `docker-compose.prod.yml`:
    - Webapp on host port 80 → container 8080, persistent `web-data:/app/data`.
    - Catalog API internal-only (no host port), Release builds via build args.
  - Wrote `DEVELOPING.md` for local workflows and updated `docs/DEPLOYING.md` for prod deployment.

## Running the Stack

- Development
  - `docker compose up --build`
  - Webapp: http://localhost:5001
  - Catalog API (Swagger): http://localhost:5002/swagger (dev only)

- Production
  - `docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build`
  - Webapp at http://<lxc-ip>/, API internal-only

## Monorepo Setup

- Added scripts for subtree-based monorepo management:
  - `scripts/monorepo-subtree-import.sh` — imports/pulls `webapp`, `translator` (and optional others) with history.
    - Handles fresh repos (creates initial commit), and `--replace-existing` backs up existing folders outside the repo before import.
  - `scripts/monorepo-after-merge.sh` — ensures `bwkt.sln` exists and adds discovered `.csproj` files.
- Successfully imported `webapp` and `translator` from their GitHub origins; `catalog-api` remains native to this monorepo (no upstream).

## Next Steps

- Webapp: add `DATA_CATALOG_URL` usage with robust local JSON fallback toggle.
- Catalog API: importer/endpoint for translator outputs; add basic paging/filtering.
- Translator: define artifact handoff format for API ingestion (e.g., `videos.json`, SRTs).
- Optional: CI workflow to build/push images and a reverse proxy for TLS in prod.

## Deployment Notes (continued)

- Implemented race filter in webapp search UI with cookie persistence and server-side filtering.
- Fixed Razor build (RZ1031) by avoiding inline C# in `<option>` attributes; used conditional blocks instead.
- Restored the full `videos.json` dataset (240 items) after subtree import reduced local data.
- Added Docker packaging + deploy flow:
  - `scripts/package-docker.sh` bundles images + compose + run.sh into `dist/bwkt-docker-*.tar.gz`.
  - `scripts/deploy-to-server.sh` uploads, extracts, loads images, and starts the stack on the server.
- LXC lessons learned on Arch: overlay2 requires `/dev/fuse` with fuse-overlayfs; falling back to `vfs` works but is slower.
  - Added `scripts/lxc-setup-docker-arch.sh` to configure Docker (auto-falls back to `vfs` if `/dev/fuse` is missing).
- Deployment success on new Arch VM via bundle + Docker Compose; Nginx reverse proxy points to VM port 80.
  - If proxying HTTPS, consider adding ForwardedHeaders middleware to avoid redirect loops.

## UI Polish

- Navbar now respects light/dark theme by using Bootstrap's theme-aware `bg-body-tertiary` and removing hard-coded `navbar-light bg-white`/`text-dark` classes.
