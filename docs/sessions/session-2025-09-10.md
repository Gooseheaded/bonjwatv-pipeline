---
date: 2025-09-10
tags: [sessions, testing, bugfix]
env: dev
---

# Session â€” 2025-09-10

## Context
- The `webapp` and `catalog-api` test projects were experiencing a bug where the test output directory (`bin/Debug/net9.0`) was being recursively copied into itself, leading to extremely long file paths and build failures. This session documents the investigation and fix for this issue.

## Changes
- **`webapp/tests/bwkt-webapp.Tests/TestWebAppFactory.cs`**: Modified the `WebApplicationFactory` to use `builder.UseSolutionRelativeContentRoot("webapp")`.
- **`catalog-api/tests/CatalogApi.Tests/ApiTests.cs`**: Modified the `WebApplicationFactory` to use `builder.UseSolutionRelativeContentRoot("catalog-api")`.
- **`webapp/tests/bwkt-webapp.Tests/bwkt-webapp.Tests.csproj`**: Added `<GenerateMvcTestingAppManifest>false</GenerateMvcTestingAppManifest>` and `<CopyMvcTestingAppManifestToOutput>false</CopyMvcTestingAppManifestToOutput>` to the `PropertyGroup`.
- **`catalog-api/tests/CatalogApi.Tests/CatalogApi.Tests.csproj`**: Added `<GenerateMvcTestingAppManifest>false</GenerateMvcTestingAppManifest>` and `<CopyMvcTestingAppManifestToOutput>false</CopyMvcTestingAppManifestToOutput>` to the `PropertyGroup`.

## Decisions
- The root cause was identified as the `WebApplicationFactory` defaulting to the test assembly's output directory as the content root. The `Microsoft.AspNetCore.Mvc.Testing` package then copies a manifest to a `bin` folder within that content root, triggering a recursive copy.
- The fix is to explicitly set the content root to the actual web project's directory, which is outside of the test project's build output directory. This is done using `UseSolutionRelativeContentRoot`.
- As a further safeguard, the generation and copying of the MVC testing application manifest is disabled in the test projects' `.csproj` files.

## Next Steps
- Manually delete the recursively created `bin` and `obj` directories from the test projects, or run `git clean -xfd` to clean up the working directory.
- Run `dotnet test` for both solutions to verify that the issue is resolved and that the nested directory structure is no longer created.

## Links
- `webapp/tests/bwkt-webapp.Tests/TestWebAppFactory.cs`
- `catalog-api/tests/CatalogApi.Tests/ApiTests.cs`
- `webapp/tests/bwkt-webapp.Tests/bwkt-webapp.Tests.csproj`
- `catalog-api/tests/CatalogApi.Tests/CatalogApi.Tests.csproj`

---

## Session Addendum: Test Failures and Bug Fixes

### Context
- After fixing the recursive directory issue, two tests in `CatalogApi.Tests` were still failing.

### Test Failure 1: `Reject_DoesNot_Delete_When_Referenced_In_Videos`
- **Symptom**: Test failed with a `404 Not Found` when trying to fetch a subtitle file that should have been preserved.
- **Root Cause**: The test setup was flawed. It created a reference to a public subtitle file in its mock `videos.json` but never created the actual physical file in the public directory for the API to serve.
- **Fix**: Modified `ApiTests.cs` to create the expected public subtitle file during the test's arrangement phase.

### Test Failure 2: `Admin_Tags_Set_Add_Remove_Update_Endpoints`
- **Symptom**: Test failed with an `Assert.Contains()` failure, indicating a newly added tag was not present.
- **Root Cause**: The `AddTag` and `RemoveTag` helper functions in `Program.cs` were not robust enough. They did not correctly handle the in-memory data type of the `tags` collection after it had been modified by a previous `SetTags` call in the same test session.
- **Fix**: Rewrote the `AddTag` and `RemoveTag` functions to correctly parse the existing tags from the in-memory `Dictionary<string, object?>` regardless of the underlying type (`JsonElement` or `string[]`), ensuring new tags are added reliably.

### Verification
- All 39 tests now pass successfully.

---

## Session Addendum 2: Flaky Test Investigation

### Context
- The `Admin_Tags_Set_Add_Remove_Update_Endpoints` test was observed to be "flaky," failing on the first run but succeeding on subsequent runs without any code changes.

### Root Cause Analysis
- The flakiness was caused by test state pollution. The test class uses an `IClassFixture<WebApplicationFactory>`, which creates a single instance of the test server that is shared across all tests in the class.
- The data repositories (`VideoRepository`, etc.) were registered with a `Singleton` lifetime. This caused the first test to run to create a single instance of the repository that was then reused by all other tests.
- Subsequent tests that configured their own data files were still receiving the already-initialized singleton, which was pointing to the data from the first test, causing unpredictable behavior and failures depending on test execution order.

### Fix
- Changed the dependency injection lifetime for `VideoRepository`, `RatingsRepository`, and `SubmissionsRepository` in `Program.cs` from `Singleton` to `Scoped`.
- A `Scoped` lifetime ensures that each test execution gets a fresh instance of the repository, properly isolating the tests from each other and guaranteeing a clean state for each run.

### Verification
- The tests now pass consistently.
