---
date: 2025-09-08
tags: [sessions]
env: both
---

# Session — 2025-09-08

## Context
- Continued API-first migration for the webapp (removed local videos.json sources).
- Added ratings-based sorting to Catalog API and integrated with webapp paging.
- Investigated and addressed bundle size growth across deployments.
- Fixed production 404s on watch/search by adding missing API route and aligning webapp routing.
- Resolved mixed content/CORS for subtitles via server-side proxy and auto-mirroring.
- Secured uploads with token auth; ensured login/session cookies persist across deploys.

## Changes
- Translator: submit uses run-root enriched JSON; fallback to .cache title; removed fallback to original non-EN title.
- Webapp: Admin Batch-Tag page (/Admin/BatchTag) + new tag “Story time”; persistent DataProtection keys (volume-backed).
- Webapp: API-first VideoService; added paged API calls; removed local JSON loader/watcher; fixed ratings display on Home/Search.
- Catalog API: added sortBy=rating_desc (Wilson LB) and Red/Yellow/Green aggregates in list payloads.
- API: added GET /api/videos/{id} and /healthz; fixed watch/search 404s.
- Webapp UI: Index/Search render rating counts inline; removed client JS fetch and client-side sort.
- Subtitles: added webapp proxy /subtitles/{id}/{version}.srt with external fallback; auto-mirrors legacy SRTs to API on first access.
- Security: secured API upload endpoint with X-Api-Key; webapp uses LEGACY_SUBTITLE_API_TOKEN (renamed) for mirroring.
- Build/Size: switched Dockerfiles to dotnet 9 alpine; added .dockerignore to shrink context; added measurement script.
- Storage: introduced primary videos store (DATA_VIDEOS_STORE_PATH → catalog-videos.json) owned by Catalog API; one-time import from legacy videos.json on startup; all writes now target the new store.
- Readiness: added GET /readyz to verify the store exists and is readable/writable.
- Tests: updated API tests to set Data:VideosStorePath and add X-Api-Key for uploads.
- Compose: dev/prod set DATA_VIDEOS_STORE_PATH and mount /app/data; docs updated.
- Webapp fix: ratings counts on Home/Search now parse API fields case-insensitively (handles red/yellow/green vs Red/Yellow/Green).
- Deployment: deploy-to-server.sh now uses SSH multiplexing (ControlMaster/ControlPersist) to prompt for the password once and reuse the connection for ssh/scp.
- Admin: added per-video Tagging Tool on Admin/Video (checkboxes + Save Tags) and implemented API endpoint PATCH /api/admin/videos/{id}/tags (add/remove/set). Batch-Tagging now updates the store via webapp proxy and changes reflect in Search/Watch.

## Decisions
- Catalog API is the single source of truth for videos; webapp depends on API for all data.
- Delegate ratings sort to API; homepage/search use API paging + sorting.
- Mirror legacy subtitles to first-party on-demand; prefer first-party URLs thereafter.
- Secure uploads via token (API_INGEST_TOKENS on API, LEGACY_SUBTITLE_API_TOKEN on webapp).
- Persist Data Protection keys to retain auth cookies across deploys.
- Do not write to legacy videos.json at runtime; keep it only as an optional bootstrap source. Catalog API owns its videos store going forward.

## Image Size Measurement (Plan + Commands)
- Rebuild images clean:
  - `docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache`
- Record sizes:
  - `docker images | grep -E 'bwkt-webapp|bwkt-catalog-api'`
  - `docker history bwkt-webapp:prod`
  - `docker history bwkt-catalog-api:prod`
- Package and record bundle size:
  - `scripts/package-docker.sh`
  - `ls -lh dist/bwkt-docker-*.tar.gz | tail -n1`
- Paste outputs here: docs/logs/docker-sizes-2025-09-08.txt

## Next Steps
- Optional: add /readyz to API for infra readiness checks.
- Optional: background job/admin tool to bulk-mirror all legacy external subtitles.
- Add metrics/logging around subtitle mirroring for visibility.
- Verify prod .env sets matching tokens (API_INGEST_TOKENS, LEGACY_SUBTITLE_API_TOKEN).
- Consider distroless/chiseled images if more savings are needed; monitor bundle size (target ~180–200MB).
- Plan DB migration (SQLite/Postgres) for videos/ratings/submissions with a migration path from catalog-videos.json.

## Links
- Image size logs: docs/logs/docker-sizes-2025-09-08.txt
- Translator fixes: `translator/translate_title.py`, `translator/build_videos_json.py`, `translator/submit_to_catalog.py`
- Admin batch tagging: `webapp/Pages/Admin/BatchTag.cshtml`, `webapp/Pages/Admin/BatchTag.cshtml.cs`
- API-first service + ratings: `webapp/Services/VideoService.cs`, `catalog-api/Program.cs`
- Subtitles proxy/mirroring: `webapp/Program.cs` (proxy), `catalog-api/Program.cs` (upload route)
- Docker sizing: `scripts/measure-docker-sizes.sh`, `.dockerignore`, `webapp/Dockerfile`, `catalog-api/Dockerfile`
- New store: DATA_VIDEOS_STORE_PATH (default /app/data/catalog-videos.json), importer in catalog-api/Services/VideoRepository.cs
- Readiness: GET /readyz in catalog-api/Program.cs
