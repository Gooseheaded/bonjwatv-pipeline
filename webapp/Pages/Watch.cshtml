@page
@model bwkt_webapp.Pages.WatchModel
@using System
@using bwkt_webapp.Helpers
@{
    ViewData["Title"] = Model.Video?.Title ?? "Watch";
    var adminIds = Environment.GetEnvironmentVariable("ADMIN_USER_IDS");
    var currentId = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isAdmin = !string.IsNullOrWhiteSpace(adminIds) && !string.IsNullOrWhiteSpace(currentId) && adminIds.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Contains(currentId);
}

@if (Model.Video == null)
{
    <div class="alert alert-danger">Video not found.</div>
}
else
{
    <h1>@Model.Video.Title</h1>
    <div class="mb-3">
        @if (!string.IsNullOrEmpty(Model.Video.Creator))
        {
            <h6 class="text-muted mb-2">By @Model.Video.Creator</h6>
        }
        @foreach (var tag in Model.Video.Tags ?? Array.Empty<string>())
        {
            var (text, css) = TagBadge.Get(tag);
            <span class="badge @css me-1">@text</span>
        }
    </div>
    <div id="theater-backdrop" class="theater-backdrop" hidden aria-hidden="true"></div>
    <div id="player-theater-shell" class="player-theater-shell">
        <div class="position-relative ratio ratio-16x9 mb-3 video-wrapper">
            <iframe id="player"
                    src="https://www.youtube.com/embed/@Model.Video.VideoId?enablejsapi=1"
                    title="@Model.Video.Title"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
            </iframe>
            <div id="subtitle-container"
                 class="position-absolute start-50 translate-middle-x subtitle-overlay">
            </div>
        </div>
    </div>
    @if (isAdmin)
    {
        <div class="mb-3">
            <a class="btn btn-sm btn-outline-primary" asp-page="/Admin/Video" asp-route-id="@Model.Video.VideoId">Admin</a>
        </div>
    }
    @if (Model.Video.SubtitleContributors?.Any() == true)
    {
        <div class="mb-2 small text-muted">
            <strong>Subtitles:</strong>
            @foreach (var c in Model.Video.SubtitleContributors.OrderBy(x => x.Version))
            {
                var date = c.SubmittedAt == DateTimeOffset.MinValue ? "" : c.SubmittedAt.ToString("yyyy-MM-dd");
                <span class="me-2">v@(c.Version) by @(string.IsNullOrWhiteSpace(c.DisplayName) ? c.UserId : c.DisplayName) @if (!string.IsNullOrEmpty(date)) {<text>on @date</text>}</span>
            }
        </div>
    }
    <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center">
            <label class="form-label me-2 mb-0">Subtitle Font Size:</label>
            <div class="btn-group btn-group-sm" role="group" aria-label="Subtitle font size">
                <button id="dec-font" type="button" class="btn btn-outline-secondary">A-</button>
                <button id="inc-font" type="button" class="btn btn-outline-secondary">A+</button>
            </div>
        </div>
        <div class="d-flex align-items-center flex-wrap gap-2">
            <label for="subtitle-pos-slider" class="form-label mb-0">Subtitle Position:</label>
            <div class="btn-group btn-group-sm" role="group" aria-label="Subtitle position presets">
                <button type="button" class="btn btn-outline-secondary" data-subtitle-pos-preset="8">Low</button>
                <button type="button" class="btn btn-outline-secondary" data-subtitle-pos-preset="28">Mid</button>
                <button type="button" class="btn btn-outline-secondary" data-subtitle-pos-preset="68">High</button>
            </div>
            <input id="subtitle-pos-slider"
                   type="range"
                   class="form-range m-0"
                   min="0"
                   max="80"
                   step="1"
                   value="8"
                   style="width: 10rem;"
                   aria-label="Subtitle position, higher moves subtitles up" />
            <button id="subtitle-pos-reset" type="button" class="btn btn-outline-secondary btn-sm">Reset</button>
        </div>
        <div class="d-flex align-items-center gap-2">
            @if (User?.Identity?.IsAuthenticated ?? false)
            {
                <button id="theater-toggle"
                        type="button"
                        class="btn btn-outline-secondary btn-sm theater-toggle-btn"
                        aria-pressed="false"
                        aria-controls="player-theater-shell"
                        data-video-id="@Model.Video.VideoId"
                        data-label-enter="Theater Mode"
                        data-label-exit="Exit Theater">
                    Theater Mode
                </button>
            }
            else
            {
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        disabled
                        aria-disabled="true">
                    Theater Mode
                </button>
                <small class="text-muted">Login to unlock Theater Mode</small>
            }
        </div>
        <div class="d-flex align-items-center">
            <div class="me-2">Rate subtitles:</div>
            <div class="btn-group" role="group" aria-label="Rate subtitles">
                <button type="button" class="btn btn-outline-danger" data-rating="red" title="Red: missing or unintelligible" disabled="@(!User?.Identity?.IsAuthenticated ?? true)">ðŸ”´ <span class="badge bg-light text-dark ms-1 rating-count">@Model.RedCount</span></button>
                <button type="button" class="btn btn-outline-warning" data-rating="yellow" title="Yellow: sometimes understandable" disabled="@(!User?.Identity?.IsAuthenticated ?? true)">ðŸŸ¡ <span class="badge bg-light text-dark ms-1 rating-count">@Model.YellowCount</span></button>
                <button type="button" class="btn btn-outline-success" data-rating="green" title="Green: understandable all around" disabled="@(!User?.Identity?.IsAuthenticated ?? true)">ðŸŸ¢ <span class="badge bg-light text-dark ms-1 rating-count">@Model.GreenCount</span></button>
            </div>
            @if (!(User?.Identity?.IsAuthenticated ?? false))
            {
                <span class="text-muted ms-2">Login to rate</span>
            }
        </div>
        <div class="text-muted">
            @if (!string.IsNullOrEmpty(Model.Video.Submitter))
            {
                <small>Submitted by @Model.Video.Submitter@if(!string.IsNullOrEmpty(Model.Video.SubmissionDate)){<text> on @Model.Video.SubmissionDate</text>}</small>
            }
        </div>
        <div>
            @if (User?.Identity?.IsAuthenticated ?? false)
            {
                <button id="open-correction"
                        type="button"
                        class="btn btn-outline-danger btn-sm"
                        data-video-id="@Model.Video.VideoId"
                        data-subtitle-version="@Model.SubtitleVersion">
                    !!! Report Subtitle Issue
                </button>
            }
            else
            {
                <small class="text-muted">Login to suggest subtitle corrections.</small>
            }
        </div>
    </div>
    <div class="modal fade" id="correctionModal" tabindex="-1" aria-labelledby="correctionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="correctionModalLabel">Suggest Subtitle Correction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Captured timestamp: <span class="fw-semibold" id="correction-timestamp">--:--</span></p>
                    <div id="correction-cues"></div>
                    <div class="mb-3">
                        <label for="correction-notes" class="form-label">Notes for reviewers (optional)</label>
                        <textarea id="correction-notes" class="form-control" rows="3" maxlength="500" placeholder="Add extra context if needed"></textarea>
                    </div>
                    <div id="correction-success" class="alert alert-success d-none" role="alert"></div>
                    <div id="correction-error" class="alert alert-danger d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <form id="correction-form" class="w-100 d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Only edit the subtitle textâ€”timings are frozen.</span>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Submit Correction</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="~/js/subtitles.js" asp-append-version="true"></script>
    <script src="~/js/watched.js"></script>
    <script src="~/js/corrections.js" asp-append-version="true"></script>
    <script src="~/js/watch-theater.js" asp-append-version="true"></script>
    <script>
        // Initialize subtitles after the YouTube IFrame API has loaded
        initSubtitles("@Model.Video.SubtitleUrl", "player", "subtitle-container");

        // Load saved font size from localStorage, if any
        const subtitleEl = document.getElementById('subtitle-container');
        const subtitlePosSlider = document.getElementById('subtitle-pos-slider');
        const subtitlePosReset = document.getElementById('subtitle-pos-reset');
        const subtitlePosPresetButtons = Array.from(document.querySelectorAll('[data-subtitle-pos-preset]'));
        const subtitlePosStorageKey = 'subtitleVerticalPct';
        const subtitlePosDefault = 8;
        const subtitlePosMin = 0;
        const subtitlePosMax = 80;
        const savedSize = parseFloat(localStorage.getItem('subtitleFontSize'));
        if (!isNaN(savedSize)) {
            subtitleEl.style.fontSize = savedSize + 'px';
        }
        initSubtitlePosition();

        // Font size adjustment controls
        const decBtn = document.getElementById('dec-font');
        const incBtn = document.getElementById('inc-font');
        decBtn.addEventListener('click', () => adjustFontSize(-2));
        incBtn.addEventListener('click', () => adjustFontSize(2));

        function adjustFontSize(deltaPx) {
            const style = window.getComputedStyle(subtitleEl);
            const current = parseFloat(style.fontSize) || 16;
            const next = Math.max(6, current + deltaPx);
            subtitleEl.style.fontSize = next + 'px';
            localStorage.setItem('subtitleFontSize', next);
            try { if (window.gtag) { window.gtag('event', 'subtitle_font_resize', { size_px: next }); } } catch {}
        }

        function clampSubtitlePos(value) {
            if (!Number.isFinite(value)) return subtitlePosDefault;
            return Math.max(subtitlePosMin, Math.min(subtitlePosMax, value));
        }

        function applySubtitlePosition(value, persist = true) {
            const next = clampSubtitlePos(value);
            subtitleEl.style.top = 'auto';
            subtitleEl.style.bottom = next + '%';
            subtitleEl.style.width = '100%';
            if (subtitlePosSlider) subtitlePosSlider.value = String(next);
            updateSubtitlePresetActive(next);
            if (persist) {
                localStorage.setItem(subtitlePosStorageKey, String(next));
            }
        }

        function updateSubtitlePresetActive(currentValue) {
            subtitlePosPresetButtons.forEach(btn => {
                const preset = Number.parseInt(btn.getAttribute('data-subtitle-pos-preset') || '', 10);
                const isMatch = Number.isFinite(preset) && preset === currentValue;
                btn.classList.toggle('active', isMatch);
                btn.setAttribute('aria-pressed', isMatch ? 'true' : 'false');
            });
        }

        function initSubtitlePosition() {
            if (!subtitleEl) return;
            const saved = parseFloat(localStorage.getItem(subtitlePosStorageKey));
            applySubtitlePosition(Number.isFinite(saved) ? saved : subtitlePosDefault, false);

            if (subtitlePosSlider) {
                subtitlePosSlider.addEventListener('input', (e) => {
                    const target = e.target;
                    const next = Number.parseFloat(target.value);
                    applySubtitlePosition(next);
                });
            }

            subtitlePosPresetButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = Number.parseInt(btn.getAttribute('data-subtitle-pos-preset') || '', 10);
                    if (!Number.isFinite(preset)) return;
                    applySubtitlePosition(preset);
                });
            });

            if (subtitlePosReset) {
                subtitlePosReset.addEventListener('click', () => {
                    localStorage.removeItem(subtitlePosStorageKey);
                    applySubtitlePosition(subtitlePosDefault, false);
                });
            }
        }

        // Ratings wiring
        const videoId = "@Model.Video.VideoId";
        let currentUserRating = null;
        async function loadRatings() {
            try {
                const res = await fetch(`/ratings/${videoId}`);
                if (!res.ok) return;
                const data = await res.json();
                // Expect properties Red, Yellow, Green
                const counts = { red: data.Red ?? 0, yellow: data.Yellow ?? 0, green: data.Green ?? 0 };
                const btns = document.querySelectorAll('[data-rating]');
                btns.forEach(b => {
                    const val = b.getAttribute('data-rating');
                    const badge = b.querySelector('.rating-count');
                    if (badge) badge.textContent = counts[val] ?? 0;
                });
                // Highlight current user rating if present
                currentUserRating = (data.UserRating || '').toLowerCase() || null;
                btns.forEach(b => b.classList.remove('active'));
                if (currentUserRating) {
                    const activeBtn = document.querySelector(`[data-rating="${currentUserRating}"]`);
                    if (activeBtn) activeBtn.classList.add('active');
                }
            } catch {}
        }

        async function postRating(value) {
            try {
                const res = await fetch(`/ratings/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, version: 1 })
                });
                if (res.ok) {
                    await loadRatings();
                }
            } catch {}
        }

        async function deleteRating() {
            try {
                const res = await fetch(`/ratings/${videoId}?version=1`, { method: 'DELETE' });
                if (res.ok) {
                    await loadRatings();
                }
            } catch {}
        }

        // Attach click handlers (enabled buttons only)
        document.querySelectorAll('[data-rating]')
            .forEach(btn => btn.addEventListener('click', () => {
                if (btn.hasAttribute('disabled')) return;
                const val = btn.getAttribute('data-rating');
                if (currentUserRating && currentUserRating === val) {
                    deleteRating();
                } else {
                    postRating(val);
                }
            }));

        loadRatings();

        // Watched marker: mark after 30s of continuous PLAYING
        (function(){
            const YTState = { UNSTARTED: -1, ENDED: 0, PLAYING: 1, PAUSED: 2, BUFFERING: 3, CUED: 5 };
            let timer = null;
            let progressTimer = null;
            let playedEventSent = false;
            const quartiles = [25, 50, 75, 95];
            const quartilesSent = new Set();
            function clearTimer(){ if (timer) { clearTimeout(timer); timer = null; } }
            function clearProgress(){ if (progressTimer) { clearInterval(progressTimer); progressTimer = null; } }
            function startTimer(){
                clearTimer();
                timer = setTimeout(async () => {
                    try {
                        // Double-check: if player is still in PLAYING state, mark watched
                        await fetch(`/account/watched/${videoId}`, { method: 'POST', credentials: 'same-origin' });
                        // Analytics: record the watched event (30s)
                        try {
                            if (window.gtag) {
                                window.gtag('event', 'video_watched_30s', {
                                    video_id: videoId,
                                    page_path: location.pathname,
                                    page_title: document.title
                                });
                            }
                        } catch {}
                        if (window.bwktWatched && typeof window.bwktWatched.refreshFromServer === 'function') {
                            await window.bwktWatched.refreshFromServer();
                        } else if (window.bwktWatched && typeof window.bwktWatched.markWatched === 'function') {
                            window.bwktWatched.markWatched(videoId);
                        }
                    } catch {}
                }, 30000);
            }
            function startProgress(player){
                clearProgress();
                progressTimer = setInterval(() => {
                    try {
                        const dur = (typeof player.getDuration === 'function') ? (player.getDuration() || 0) : 0;
                        const cur = (typeof player.getCurrentTime === 'function') ? (player.getCurrentTime() || 0) : 0;
                        if (dur > 0) {
                            const pct = Math.max(0, Math.min(100, Math.floor((cur / dur) * 100)));
                            for (const q of quartiles) {
                                if (pct >= q && !quartilesSent.has(q)) {
                                    quartilesSent.add(q);
                                    try { if (window.gtag) { window.gtag('event', 'video_quartile', { video_id: videoId, quartile: q }); } } catch {}
                                }
                            }
                        }
                    } catch {}
                }, 1000);
            }
            window.bwktOnPlayerStateChange = function(state, player) {
                if (state === YTState.PLAYING) {
                    if (!playedEventSent) {
                        playedEventSent = true;
                        try { if (window.gtag) { window.gtag('event', 'video_play', { video_id: videoId }); } } catch {}
                    }
                    startTimer();
                    startProgress(player);
                } else if (state === YTState.PAUSED) {
                    clearTimer();
                    try {
                        const dur = (typeof player.getDuration === 'function') ? (player.getDuration() || 0) : 0;
                        const cur = (typeof player.getCurrentTime === 'function') ? (player.getCurrentTime() || 0) : 0;
                        const pct = dur > 0 ? Math.round((cur / dur) * 100) : null;
                        if (window.gtag) { window.gtag('event', 'video_pause', { video_id: videoId, progress_pct: pct }); }
                    } catch {}
                    clearProgress();
                } else if (state === YTState.ENDED) {
                    clearTimer();
                    try { if (window.gtag) { window.gtag('event', 'video_complete', { video_id: videoId }); } } catch {}
                    clearProgress();
                } else {
                    clearTimer();
                }
            };
            // Best-effort cleanup on page unload
            window.addEventListener('beforeunload', () => { clearTimer(); clearProgress(); });
        })();
    </script>
}
