@page
@model bwkt_webapp.Pages.Admin.CreatorMappings.IndexModel
@{
    ViewData["Title"] = "Creator Mappings";
}

<h1>Creator Mappings</h1>

@if (!Model.IsAdmin)
{
    <div class="alert alert-warning">You do not have access to this page.</div>
}

@if (Model.IsAdmin)
{
    <div class="d-flex gap-2 mb-3">
        <a class="btn btn-primary" asp-page="/Admin/CreatorMappings/Create">New Mapping</a>
        <form method="post" asp-page-handler="Reapply" onsubmit="return confirm('Reapply mappings to all videos and submissions?');">
            <button type="submit" class="btn btn-outline-secondary">Reapply to Existing</button>
        </form>
    </div>

    <form method="get" class="mb-3 d-flex" role="search">
        <input type="text" name="q" value="@Model.Query" placeholder="Search source or canonical" class="form-control me-2" />
        <button type="submit" class="btn btn-outline-primary">Search</button>
    </form>

    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-sm-6">
                    <label for="trySource" class="form-label">Try-it: Source</label>
                    <input id="trySource" name="try" value="@Model.TrySource" class="form-control" />
                </div>
                <div class="col-sm-3">
                    <button type="submit" class="btn btn-secondary">Resolve</button>
                </div>
                <div class="col-sm-12 mt-2">
                    <small class="text-muted">Result: @(string.IsNullOrWhiteSpace(Model.TryResult) ? "(no match)" : Model.TryResult)</small>
                </div>
            </form>
        </div>
    </div>

    @if (Model.Items.Count == 0)
    {
        <p>No mappings found.</p>
    }
    else
    {
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Canonical</th>
                    <th>Notes</th>
                    <th>Updated</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            @foreach (var m in Model.Items)
            {
                <tr>
                    <td>@m.Source</td>
                    <td>@m.Canonical</td>
                    <td>@m.Notes</td>
                    <td>@m.UpdatedAt.ToString("u")</td>
                    <td class="text-nowrap">
                        <a class="btn btn-sm btn-primary" asp-page="/Admin/CreatorMappings/Edit" asp-route-id="@m.Id" asp-route-source="@m.Source" asp-route-canonical="@m.Canonical" asp-route-notes="@m.Notes">Edit</a>
                        <form method="post" asp-page-handler="Delete" class="d-inline" onsubmit="return confirm('Delete this mapping?');">
                            <input type="hidden" name="id" value="@m.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>

        <nav>
            <ul class="pagination">
                <li class="page-item @(Model.PageNum <= 1 ? "disabled" : "")">
                    <a class="page-link" href="?q=@Model.Query&page=@(Model.PageNum-1)&pageSize=@Model.PageSize">Previous</a>
                </li>
                <li class="page-item disabled"><span class="page-link">Page @Model.PageNum</span></li>
                <li class="page-item @((Model.PageNum * Model.PageSize >= Model.TotalCount) ? "disabled" : "")">
                    <a class="page-link" href="?q=@Model.Query&page=@(Model.PageNum+1)&pageSize=@Model.PageSize">Next</a>
                </li>
            </ul>
        </nav>
    }
}
